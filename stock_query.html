<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票信息查询 - 股票智能筛选器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        .stock-result {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        .stock-result h2 {
            margin-top: 0;
            color: #333;
        }
        .stock-info {
            margin-bottom: 10px;
        }
        .stock-info span {
            font-weight: bold;
        }
        .price {
            font-size: 28px;
            font-weight: bold;
            color: #4CAF50;
            margin: 15px 0;
        }
        .market-cap {
            font-size: 20px;
            color: #3498db;
            margin-bottom: 15px;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #e74c3c;
            padding: 10px;
            background-color: #ffeaea;
            border-radius: 4px;
            margin-top: 20px;
            display: none;
        }
        .nav-links {
            text-align: center;
            margin-top: 30px;
        }
        .nav-links a {
            color: #3498db;
            text-decoration: none;
            margin: 0 10px;
        }
        .nav-links a:hover {
            text-decoration: underline;
        }
        .timestamp {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>股票信息查询</h1>
        
        <div class="form-group">
            <label for="stockTicker">输入股票代码:</label>
            <input type="text" id="stockTicker" placeholder="例如: AAPL, MSFT, BABA">
            <button id="queryButton">查询</button>
        </div>
        
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>正在获取股票数据，请稍候...</p>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="stock-result" id="stockResult">
            <h2 id="companyName"></h2>
            <div class="stock-info">股票代码: <span id="tickerSymbol"></span></div>
            <div class="price" id="currentPrice"></div>
            <div class="market-cap" id="marketCap"></div>
            <div class="stock-info">行业: <span id="sector"></span></div>
            <div class="timestamp" id="updateTime"></div>
        </div>
        
        <div class="nav-links">
            <a href="index.html">返回股票筛选器</a>
        </div>
    </div>

    <script>
        // 预定义的一些常见股票数据
        const STOCK_DATA = {
            "AAPL": {"name": "苹果公司", "price_range": [170, 190], "market_cap": "2.8万亿", "sector": "科技 - 消费电子"},
            "MSFT": {"name": "微软公司", "price_range": [330, 350], "market_cap": "2.7万亿", "sector": "科技 - 软件"},
            "GOOGL": {"name": "Alphabet公司", "price_range": [140, 160], "market_cap": "1.7万亿", "sector": "科技 - 互联网"},
            "AMZN": {"name": "亚马逊公司", "price_range": [170, 190], "market_cap": "1.5万亿", "sector": "消费者服务 - 电子商务"},
            "META": {"name": "Meta平台公司", "price_range": [450, 470], "market_cap": "1.2万亿", "sector": "科技 - 社交媒体"},
            "TSLA": {"name": "特斯拉公司", "price_range": [210, 230], "market_cap": "7500亿", "sector": "汽车制造"},
            "NVDA": {"name": "英伟达公司", "price_range": [100, 120], "market_cap": "1.1万亿", "sector": "科技 - 半导体"},
            "BABA": {"name": "阿里巴巴集团", "price_range": [70, 90], "market_cap": "2000亿", "sector": "消费者服务 - 电子商务"},
            "PDD": {"name": "拼多多公司", "price_range": [120, 140], "market_cap": "1800亿", "sector": "消费者服务 - 电子商务"},
            "JD": {"name": "京东集团", "price_range": [25, 35], "market_cap": "500亿", "sector": "消费者服务 - 电子商务"}
        };

        // 获取随机价格
        function getRandomPrice(min, max) {
            return (Math.random() * (max - min) + min).toFixed(2);
        }

        // 查询股票信息
        async function queryStock() {
            // 获取股票代码
            const ticker = document.getElementById('stockTicker').value.trim().toUpperCase();
            
            if (!ticker) {
                showError("请输入有效的股票代码");
                return;
            }
            
            // 显示加载指示器
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('stockResult').style.display = 'none';
            
            // 尝试从Yahoo Finance获取真实数据
            try {
                // 定义多个代理尝试
                const proxies = [
                    'https://corsproxy.io/?',
                    'https://api.allorigins.win/raw?url=',
                    'https://cors-anywhere.herokuapp.com/'
                ];
                
                let realData = null;
                
                // 依次尝试每个代理
                for (const proxyUrl of proxies) {
                    try {
                        console.log(`尝试使用代理获取${ticker}的数据: ${proxyUrl}`);
                        const yahooFinanceUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`;
                        
                        const response = await fetch(proxyUrl + encodeURIComponent(yahooFinanceUrl));
                        const data = await response.json();
                        
                        if (data && data.chart && data.chart.result && data.chart.result.length > 0) {
                            const result = data.chart.result[0];
                            const quote = result.indicators.quote[0];
                            const currentPrice = quote.close[quote.close.length - 1];
                            
                            // 尝试获取更多信息
                            const summaryUrl = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${ticker}?modules=summaryProfile,price,defaultKeyStatistics`;
                            const metaResponse = await fetch(proxyUrl + encodeURIComponent(summaryUrl));
                            const metaData = await metaResponse.json();
                            
                            if (metaData && metaData.quoteSummary && metaData.quoteSummary.result && metaData.quoteSummary.result.length > 0) {
                                const profile = metaData.quoteSummary.result[0].summaryProfile || {};
                                const priceInfo = metaData.quoteSummary.result[0].price || {};
                                
                                // 提取市值
                                let marketCap = 0;
                                let marketCapStr = "未知";
                                if (priceInfo.marketCap && priceInfo.marketCap.raw) {
                                    marketCap = priceInfo.marketCap.raw;
                                    if (marketCap >= 1e12) {
                                        marketCapStr = `${(marketCap/1e12).toFixed(2)}万亿`;
                                    } else if (marketCap >= 1e9) {
                                        marketCapStr = `${(marketCap/1e9).toFixed(2)}十亿`;
                                    } else if (marketCap >= 1e6) {
                                        marketCapStr = `${(marketCap/1e6).toFixed(2)}百万`;
                                    }
                                }
                                
                                realData = {
                                    ticker: ticker,
                                    name: priceInfo.shortName || `${ticker}公司`,
                                    price: currentPrice,
                                    marketCap: marketCapStr,
                                    sector: profile.sector || "未知",
                                    timestamp: new Date().toLocaleString('zh-CN')
                                };
                                
                                console.log(`成功获取${ticker}的真实数据`);
                                break; // 成功获取数据，跳出代理循环
                            }
                        }
                    } catch (proxyError) {
                        console.warn(`代理${proxyUrl}请求失败: ${proxyError}`);
                        // 继续尝试下一个代理
                    }
                }
                
                // 如果无法获取真实数据，使用模拟数据
                if (!realData) {
                    console.log(`无法获取${ticker}的真实数据，使用模拟数据`);
                    
                    // 检查是否是预定义的股票
                    if (ticker in STOCK_DATA) {
                        const stock = STOCK_DATA[ticker];
                        const price = getRandomPrice(stock.price_range[0], stock.price_range[1]);
                        
                        realData = {
                            ticker: ticker,
                            name: stock.name,
                            price: price,
                            marketCap: stock.market_cap,
                            sector: stock.sector,
                            timestamp: new Date().toLocaleString('zh-CN'),
                            isMock: true
                        };
                    } else {
                        // 对于未知股票，生成随机数据
                        const price = getRandomPrice(10, 500);
                        const capValue = getRandomPrice(1, 100);
                        const capUnits = ["亿", "十亿", "百亿", "千亿", "万亿"];
                        const capUnit = capUnits[Math.floor(Math.random() * capUnits.length)];
                        
                        realData = {
                            ticker: ticker,
                            name: `${ticker}公司`,
                            price: price,
                            marketCap: `${capValue}${capUnit}`,
                            sector: "未知",
                            timestamp: new Date().toLocaleString('zh-CN'),
                            isMock: true
                        };
                    }
                }
                
                // 显示结果
                displayStockInfo(realData);
            } catch (error) {
                console.error(`获取${ticker}数据时出错: ${error}`);
                showError(`获取股票数据时出错: ${error.message}`);
            } finally {
                // 隐藏加载指示器
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }
        
        // 显示股票信息
        function displayStockInfo(stockInfo) {
            document.getElementById('tickerSymbol').textContent = stockInfo.ticker;
            document.getElementById('companyName').textContent = stockInfo.name;
            document.getElementById('currentPrice').textContent = `$${stockInfo.price}`;
            document.getElementById('marketCap').textContent = `市值: ${stockInfo.marketCap}`;
            document.getElementById('sector').textContent = stockInfo.sector;
            
            let timeText = `更新时间: ${stockInfo.timestamp}`;
            if (stockInfo.isMock) {
                timeText += " (模拟数据)";
            }
            document.getElementById('updateTime').textContent = timeText;
            
            document.getElementById('stockResult').style.display = 'block';
        }
        
        // 显示错误信息
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            document.getElementById('stockResult').style.display = 'none';
        }
        
        // 添加事件监听器
        document.getElementById('queryButton').addEventListener('click', queryStock);
        
        // 添加回车键触发查询功能
        document.getElementById('stockTicker').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                queryStock();
            }
        });
        
        // 如果URL中包含股票代码参数，自动查询
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const ticker = urlParams.get('ticker');
            if (ticker) {
                document.getElementById('stockTicker').value = ticker;
                queryStock();
            }
        });
    </script>
</body>
</html>